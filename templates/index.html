<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Model Selection Tool</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 300;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .form-container {
        padding: 40px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 1.1em;
      }

      .form-group select,
      .form-group input[type="file"] {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s ease;
      }

      .form-group select:focus,
      .form-group input[type="file"]:focus {
        outline: none;
        border-color: #667eea;
      }

      .file-upload {
        border: 2px dashed #e1e5e9;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        transition: border-color 0.3s ease;
        cursor: pointer;
      }

      .file-upload:hover {
        border-color: #667eea;
      }

      .file-upload.dragover {
        border-color: #667eea;
        background-color: #f8f9ff;
      }

      .submit-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .submit-btn:hover {
        transform: translateY(-2px);
      }

      .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .result-container {
        margin-top: 30px;
        padding: 20px;
        border-radius: 8px;
        display: none;
      }

      .result-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .result-error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .loading {
        display: none;
        text-align: center;
        margin-top: 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .add-model-btn {
        background: #f8f9fa;
        border: 2px dashed #667eea;
        color: #667eea;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        margin-top: 10px;
        width: 100%;
        transition: all 0.3s ease;
      }

      .add-model-btn:hover {
        background: #667eea;
        color: white;
      }

      .model-comparison-item {
        background: #f8f9fa;
        border: 1px solid #e1e5e9;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .model-comparison-item select {
        flex: 1;
        margin: 0;
      }

      .remove-model-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 0.8em;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .metric-card {
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        border: 1px solid #e1e5e9;
      }

      .metric-value {
        font-size: 1.2em;
        font-weight: bold;
        color: #667eea;
      }

      .metric-label {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
      }

      .comparison-result {
        background: #f8f9fa;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        margin: 15px 0;
        padding: 15px;
      }

      .comparison-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #e1e5e9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🤖 Model Selection Tool</h1>
        <p>Análisis de imágenes con IA - Selecciona tu modelo preferido</p>
      </div>

      <div class="form-container">
        <form id="analyzeForm" enctype="multipart/form-data">
          <div class="form-group">
            <label for="mode">Modo de análisis:</label>
            <select id="mode" name="mode" required>
              <option value="single">Análisis individual</option>
              <option value="compare">Comparar modelos</option>
            </select>
          </div>

          <div class="form-group">
            <label for="provider">Proveedor de IA:</label>
            <select id="provider" name="provider" required>
              <option value="">Selecciona un proveedor...</option>
              {% for provider in models.keys() %}
              <option value="{{ provider }}">{{ provider.title() }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="model_name">Modelo:</label>
            <select id="model_name" name="model_name" required disabled>
              <option value="">Primero selecciona un proveedor...</option>
            </select>
          </div>

          <!-- Sección para comparación de modelos -->
          <div id="compareSection" style="display: none">
            <div class="form-group">
              <label>Modelos adicionales para comparar:</label>
              <div id="additionalModels"></div>
              <button type="button" id="addModelBtn" class="add-model-btn">
                ➕ Agregar modelo
              </button>
            </div>
          </div>

          <div class="form-group">
            <label for="image">Imagen a analizar:</label>
            <div
              class="file-upload"
              onclick="document.getElementById('image').click()"
            >
              <input
                type="file"
                id="image"
                name="image"
                accept="image/*"
                required
                style="display: none"
              />
              <p>📸 Haz clic aquí o arrastra una imagen</p>
              <p style="font-size: 0.9em; color: #666; margin-top: 10px">
                Formatos soportados: JPG, PNG, GIF, WebP
              </p>
            </div>
          </div>

          <button type="submit" class="submit-btn">🚀 Analizar Imagen</button>
        </form>

        <div class="loading">
          <div class="spinner"></div>
          <p style="margin-top: 15px">Analizando imagen... Por favor espera</p>
        </div>

        <div id="result" class="result-container"></div>
      </div>
    </div>

    <script id="models-data" type="application/json">
      {{ models | tojson | safe }}
    </script>
    <script>
      console.log("Script iniciado");
      
      try {
        // Modelos disponibles desde el backend
        const modelsDataElement = document.getElementById("models-data");
        console.log("Elemento models-data:", modelsDataElement);
        
        const availableModels = JSON.parse(modelsDataElement.textContent);
        console.log("Modelos cargados:", availableModels);

        // Referencias a elementos
        const form = document.getElementById("analyzeForm");
        console.log("Form encontrado:", form);

        if (form) {
          form.addEventListener("submit", function(e) {
            e.preventDefault();
            console.log("¡Formulario enviado!");
            alert("Formulario enviado correctamente!");
          });
          console.log("Event listener agregado al form");
        }
        
      } catch (error) {
        console.error("Error en JavaScript:", error);
      }
    </script>

      // Manejar cambio de modo
      modeSelect.addEventListener("change", function () {
        const isCompare = this.value === "compare";
        compareSection.style.display = isCompare ? "block" : "none";

        if (isCompare && additionalModels.children.length === 0) {
          addModelComparison();
        }
      });

      // Agregar modelo para comparación
      addModelBtn.addEventListener("click", addModelComparison);

      function addModelComparison() {
        modelCount++;
        const modelDiv = document.createElement("div");
        modelDiv.className = "model-comparison-item";
        modelDiv.innerHTML = `
              <select class="compare-provider" data-index="${modelCount}" required>
                  <option value="">Proveedor...</option>
                  ${Object.keys(availableModels)
                    .map(
                      (provider) =>
                        `<option value="${provider}">${
                          provider.charAt(0).toUpperCase() + provider.slice(1)
                        }</option>`
                    )
                    .join("")}
              </select>
              <select class="compare-model" data-index="${modelCount}" required disabled>
                  <option value="">Modelo...</option>
              </select>
              <button type="button" class="remove-model-btn" onclick="removeModelComparison(this)">✖</button>
          `;
        additionalModels.appendChild(modelDiv);

        // Agregar event listener para el proveedor
        const providerSelect = modelDiv.querySelector(".compare-provider");
        const modelSelect = modelDiv.querySelector(".compare-model");

        providerSelect.addEventListener("change", function () {
          updateModelOptions(this.value, modelSelect);
        });
      }

      function removeModelComparison(btn) {
        btn.parentElement.remove();
      }

      function updateModelOptions(provider, modelSelect) {
        modelSelect.innerHTML = '<option value="">Modelo...</option>';

        if (provider && availableModels[provider]) {
          modelSelect.disabled = false;
          availableModels[provider].forEach((model) => {
            const option = document.createElement("option");
            option.value = model;
            option.textContent = model;
            modelSelect.appendChild(option);
          });
        } else {
          modelSelect.disabled = true;
        }
      }

      // Actualizar modelos según proveedor seleccionado (principal)
      providerSelect.addEventListener("change", function () {
        updateModelOptions(this.value, modelSelect);
      });

      // Manejar selección de archivo
      fileInput.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
          fileUpload.innerHTML = `
                  <input type="file" id="image" name="image" accept="image/*" required style="display: none;">
                  <p>✅ ${file.name}</p>
                  <p style="font-size: 0.9em; color: #666; margin-top: 10px;">Tamaño: ${(
                    file.size /
                    1024 /
                    1024
                  ).toFixed(2)} MB</p>
              `;
        }
      });

      // Drag & Drop
      fileUpload.addEventListener("dragover", function (e) {
        e.preventDefault();
        this.classList.add("dragover");
      });

      fileUpload.addEventListener("dragleave", function () {
        this.classList.remove("dragover");
      });

      fileUpload.addEventListener("drop", function (e) {
        e.preventDefault();
        this.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          fileInput.dispatchEvent(new Event("change"));
        }
      });

      // Manejar envío del formulario
      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        console.log("Form submitted!"); // Debug

        const formData = new FormData();
        const mode = modeSelect.value;
        console.log("Mode:", mode); // Debug

        // Verificar que hay una imagen seleccionada
        if (!fileInput.files[0]) {
          alert("Por favor selecciona una imagen");
          return;
        }

        // Agregar imagen
        formData.append("image", fileInput.files[0]);
        console.log("Image added:", fileInput.files[0].name); // Debug

        // Mostrar loading
        loading.style.display = "block";
        result.style.display = "none";

        try {
          let response;

          if (mode === "single") {
            // Análisis individual
            formData.append("provider", providerSelect.value);
            formData.append("model_name", modelSelect.value);
            console.log(
              "Provider:",
              providerSelect.value,
              "Model:",
              modelSelect.value
            ); // Debug

            response = await fetch("/api/analyze", {
              method: "POST",
              body: formData,
            });
          } else {
            // Comparación de modelos
            const providers = [providerSelect.value];
            const models = [modelSelect.value];

            // Agregar modelos adicionales
            const compareProviders =
              document.querySelectorAll(".compare-provider");
            const compareModels = document.querySelectorAll(".compare-model");

            compareProviders.forEach((provider, index) => {
              if (provider.value && compareModels[index].value) {
                providers.push(provider.value);
                models.push(compareModels[index].value);
              }
            });

            formData.append("providers", providers.join(","));
            formData.append("models", models.join(","));

            response = await fetch("/api/compare", {
              method: "POST",
              body: formData,
            });
          }

          console.log("Response received:", response.status); // Debug
          const data = await response.json();
          console.log("Data received:", data); // Debug

          if (response.ok) {
            if (mode === "single") {
              displaySingleResult(data);
            } else {
              displayComparisonResult(data);
            }
          } else {
            displayError(data.detail || "Error desconocido");
          }
        } catch (error) {
          console.error("Error:", error); // Debug
          displayError(`Error de conexión: ${error.message}`);
        } finally {
          loading.style.display = "none";
          result.style.display = "block";
        }
      });

      function displaySingleResult(data) {
        result.className = "result-container result-success";
        result.innerHTML = `
              <h3>✅ Análisis Completado</h3>
              <div class="metrics-grid">
                  <div class="metric-card">
                      <div class="metric-value">${data.metrics.total_time_seconds}s</div>
                      <div class="metric-label">Tiempo Total</div>
                  </div>
                  <div class="metric-card">
                      <div class="metric-value">${data.metrics.inference_time_seconds}s</div>
                      <div class="metric-label">Tiempo de Inferencia</div>
                  </div>
                  <div class="metric-card">
                      <div class="metric-value">${data.metrics.words_per_second}</div>
                      <div class="metric-label">Palabras/segundo</div>
                  </div>
                  <div class="metric-card">
                      <div class="metric-value">${data.metrics.processing_speed_mb_per_sec} MB/s</div>
                      <div class="metric-label">Velocidad de Procesamiento</div>
                  </div>
              </div>
              <p><strong>Proveedor:</strong> ${data.model_info.provider}</p>
              <p><strong>Modelo:</strong> ${data.model_info.model_name}</p>
              <p><strong>Archivo:</strong> ${data.image_info.filename} (${data.image_info.size_mb} MB)</p>
              <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 5px;">
                  <strong>Análisis:</strong><br>
                  ${data.analysis}
              </div>
          `;
      }

      function displayComparisonResult(data) {
        result.className = "result-container result-success";
        let comparisonHtml = `
              <h3>📊 Comparación de Modelos</h3>
              <div class="metrics-grid">
                  <div class="metric-card">
                      <div class="metric-value">${data.comparison_metrics.total_comparison_time}s</div>
                      <div class="metric-label">Tiempo Total</div>
                  </div>
                  <div class="metric-card">
                      <div class="metric-value">${data.comparison_metrics.successful_models}/${data.comparison_metrics.models_tested}</div>
                      <div class="metric-label">Modelos Exitosos</div>
                  </div>
                  <div class="metric-card">
                      <div class="metric-value">${data.comparison_metrics.average_inference_time}s</div>
                      <div class="metric-label">Tiempo Promedio</div>
                  </div>
                  <div class="metric-card">
                      <div class="metric-value">${data.comparison_metrics.average_response_length}</div>
                      <div class="metric-label">Palabras Promedio</div>
                  </div>
              </div>

              <div class="comparison-result">
                  <div class="comparison-title">🏆 Modelo Más Rápido</div>
                  <p><strong>${data.comparison_metrics.fastest_model.provider}/${data.comparison_metrics.fastest_model.model}</strong> - ${data.comparison_metrics.fastest_model.inference_time}s</p>
              </div>

              <div class="comparison-result">
                  <div class="comparison-title">📝 Modelo Más Detallado</div>
                  <p><strong>${data.comparison_metrics.most_verbose.provider}/${data.comparison_metrics.most_verbose.model}</strong> - ${data.comparison_metrics.most_verbose.words_count} palabras</p>
              </div>
          `;

        // Agregar resultados individuales
        data.individual_results.forEach((result) => {
          if (result.success) {
            comparisonHtml += `
                      <div class="comparison-result">
                          <div class="comparison-title">${result.provider}/${result.model}</div>
                          <div class="metrics-grid">
                              <div class="metric-card">
                                  <div class="metric-value">${result.inference_time}s</div>
                                  <div class="metric-label">Tiempo</div>
                              </div>
                              <div class="metric-card">
                                  <div class="metric-value">${result.words_count}</div>
                                  <div class="metric-label">Palabras</div>
                              </div>
                              <div class="metric-card">
                                  <div class="metric-value">${result.words_per_second}</div>
                                  <div class="metric-label">Palabras/s</div>
                              </div>
                          </div>
                          <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 3px;">
                              <strong>Análisis:</strong><br>
                              ${result.analysis}
                          </div>
                      </div>
                  `;
          } else {
            comparisonHtml += `
                      <div class="comparison-result" style="border-color: #dc3545;">
                          <div class="comparison-title" style="color: #dc3545;">❌ ${result.provider}/${result.model}</div>
                          <p style="color: #dc3545;">Error: ${result.error}</p>
                      </div>
                  `;
          }
        });

        result.innerHTML = comparisonHtml;
      }

      function displayError(message) {
        result.className = "result-container result-error";
        result.innerHTML = `
              <h3>❌ Error en el Análisis</h3>
              <p>${message}</p>
          `;
      }
    </script>
  </body>
</html>

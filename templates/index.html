<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Comparador de Modelos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      #dropZone {
        border: 2px dashed #ccc;
        padding: 20px;
        text-align: center;
        border-radius: 10px;
        background-color: #fff;
        transition: background-color 0.3s;
      }
      #dropZone.drag-over {
        background-color: #e3f2fd;
      }
    </style>
  </head>
  <body class="container py-4">
    <h1 class="mb-4">
      <i class="bi bi-lightning-charge"></i> Comparador de Modelos
    </h1>

    <!-- Zona de carga de imagen -->
    <div id="dropZone" class="mb-3">
      <p class="mb-1">
        <i class="bi bi-cloud-upload"></i> Arrastra una imagen aquí o
        selecciónala:
      </p>
      <input
        type="file"
        id="imageInput"
        accept="image/*"
        class="form-control"
      />
    </div>
    <div id="imagePreview" class="mb-4"></div>

    <!-- Tabla de modelos -->
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <span><i class="bi bi-cpu"></i> Modelos a Comparar</span>
        <button class="btn btn-primary btn-sm" onclick="addModelRow()">
          <i class="bi bi-plus-circle"></i> Añadir Modelo
        </button>
      </div>
      <div class="card-body p-0">
        <table class="table table-striped mb-0">
          <thead>
            <tr>
              <th>Proveedor</th>
              <th>Modelo</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="modelsTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Botón de comparar -->
    <div class="mt-4">
      <button id="compareBtn" class="btn btn-success" disabled>
        <i class="bi bi-lightning"></i> Comparar Modelos
      </button>
    </div>

    <!-- Resultados -->
    <div id="comparisonResults" class="mt-4"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let availableModels = [];
      let selectedModels = [];
      let selectedImage = null;

      // ---------- Inicialización ----------
      window.addEventListener("DOMContentLoaded", async () => {
        await loadModels();
        addModelRow(); // fila inicial
        initDragDrop();
        initCompareButton();
      });

      // ---------- Cargar modelos ----------
      async function loadModels() {
        try {
          const res = await fetch("/api/models");
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();

          availableModels = [];
          for (const [provider, models] of Object.entries(data)) {
            for (const modelName of models) {
              availableModels.push({
                provider: provider,
                name: modelName,
              });
            }
          }

          console.log("Modelos cargados:", availableModels);

          if (!availableModels.length) {
            alert("No se encontraron modelos. Verifica el backend.");
          }
        } catch (err) {
          console.error("Error al cargar modelos:", err);
          availableModels = [];
        }
      }

      function getModelsByProvider() {
        return availableModels.reduce((acc, model) => {
          acc[model.provider] = acc[model.provider] || [];
          acc[model.provider].push(model);
          return acc;
        }, {});
      }

      // ---------- Imagen ----------
      function initDragDrop() {
        const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("imageInput");

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("drag-over");
        });

        dropZone.addEventListener("dragleave", () =>
          dropZone.classList.remove("drag-over")
        );

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("drag-over");
          handleImageSelection(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener("change", (e) => {
          handleImageSelection(e.target.files[0]);
        });
      }

      function handleImageSelection(file) {
        if (
          !file ||
          !file.type.startsWith("image/") ||
          file.size > 10 * 1024 * 1024
        ) {
          alert("Archivo inválido o demasiado grande (máx. 10MB).");
          return;
        }
        selectedImage = file;

        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById("imagePreview").innerHTML = `
            <img src="${
              e.target.result
            }" alt="Preview" class="img-fluid rounded shadow-sm">
            <small class="text-muted mt-2 d-block"><i class="bi bi-file-image"></i> ${
              file.name
            } (${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
          `;
        };
        reader.readAsDataURL(file);

        updateCompareButton();
      }

      // ---------- Fila de modelo ----------
      function addModelRow() {
        const id = "model_" + Date.now();
        const tbody = document.getElementById("modelsTableBody");
        const providers = Object.keys(getModelsByProvider());

        tbody.insertAdjacentHTML(
          "beforeend",
          `
          <tr id="${id}">
            <td>
              <select class="form-select form-select-sm provider-select" onchange="updateModelOptions('${id}')">
                <option value="">-- Seleccionar Proveedor --</option>
                ${providers
                  .map(
                    (p) => `<option value="${p}">${p.toUpperCase()}</option>`
                  )
                  .join("")}
              </select>
            </td>
            <td>
              <select class="form-select form-select-sm model-select" disabled>
                <option value="">-- Primero selecciona proveedor --</option>
              </select>
            </td>
            <td>
              <span class="badge bg-warning">
                <i class="bi bi-exclamation-triangle"></i> Incompleto
              </span>
            </td>
            <td>
              <button class="btn btn-outline-danger btn-sm" onclick="removeModelRow('${id}')">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `
        );
      }

      function updateModelOptions(id) {
        const row = document.getElementById(id);
        const provider = row.querySelector(".provider-select").value;
        const modelSelect = row.querySelector(".model-select");
        const badge = row.querySelector(".badge");

        if (provider) {
          const models = getModelsByProvider()[provider] || [];
          modelSelect.disabled = false;
          modelSelect.innerHTML = `
            <option value="">-- Usar modelo por defecto --</option>
            ${models
              .map((m) => `<option value="${m.name}">${m.name}</option>`)
              .join("")}
          `;
          badge.className = "badge bg-success";
          badge.innerHTML = '<i class="bi bi-check-circle"></i> Listo';
        } else {
          modelSelect.disabled = true;
          modelSelect.innerHTML =
            '<option value="">-- Primero selecciona proveedor --</option>';
          badge.className = "badge bg-warning";
          badge.innerHTML =
            '<i class="bi bi-exclamation-triangle"></i> Incompleto';
        }

        updateSelectedModels();
      }

      function removeModelRow(id) {
        document.getElementById(id)?.remove();
        updateSelectedModels();
      }

      function updateSelectedModels() {
        selectedModels = [...document.querySelectorAll("#modelsTableBody tr")]
          .map((row) => {
            return {
              provider: row.querySelector(".provider-select").value,
              model: row.querySelector(".model-select").value || null,
            };
          })
          .filter((m) => m.provider);

        updateCompareButton();
      }

      // ---------- Comparación ----------
      function initCompareButton() {
        const btn = document.getElementById("compareBtn");
        btn.addEventListener("click", async () => {
          // Actualizar lista antes de enviar
          updateSelectedModels();

          if (!selectedImage) {
            alert("Por favor, selecciona una imagen.");
            return;
          }

          const validModels = selectedModels.filter(
            (m) => m.provider && m.model
          );
          if (validModels.length === 0) {
            alert(
              "Por favor, selecciona al menos un modelo válido (proveedor + modelo)."
            );
            return;
          }

          await analyzeModels(selectedImage, validModels);
        });
      }

      async function analyzeModels(imageFile, models) {
        const btn = document.getElementById("compareBtn");
        const originalText = btn.innerHTML;

        try {
          btn.disabled = true;
          btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Analizando...';

          // Preparar datos para el endpoint compare-sequential
          const formData = new FormData();
          formData.append("image", imageFile);

          // Crear arrays de proveedores y modelos para compare-sequential
          const providers = models.map((m) => m.provider).join(",");
          const modelNames = models.map((m) => m.model).join(",");

          formData.append("providers", providers);
          formData.append("models", modelNames);

          console.log("Enviando análisis:", { imageFile, models });
          console.log("Datos formateados:", { providers, models: modelNames });

          const response = await fetch("/api/compare-sequential", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(
              `Error ${response.status}: ${
                errorData.detail || response.statusText
              }`
            );
          }

          const result = await response.json();
          console.log("Resultados de análisis:", result);

          displayComparisonResults(result);
        } catch (error) {
          console.error("Error en análisis:", error);
          alert(`Error al analizar modelos: ${error.message}`);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      // ---------- Mostrar resultados ----------
      function displayAnalysisResults(results) {
        const container = document.getElementById("comparisonResults");
        if (!results) {
          container.innerHTML =
            '<div class="alert alert-warning">No se recibieron resultados.</div>';
          return;
        }

        container.innerHTML = `
          <div class="card">
            <div class="card-header">
              <h5><i class="bi bi-bar-chart"></i> Resultados del Análisis</h5>
            </div>
            <div class="card-body">
              <pre>${JSON.stringify(results, null, 2)}</pre>
            </div>
          </div>
        `;
      }

      // ---------- Botón actualización ----------
      function updateCompareButton() {
        const btn = document.getElementById("compareBtn");
        const validModels = selectedModels.filter((m) => m.provider && m.model);
        const canCompare = selectedImage && validModels.length > 0;

        btn.disabled = !canCompare;
        btn.innerHTML = canCompare
          ? `<i class="bi bi-lightning"></i> Comparar ${validModels.length} Modelo(s)`
          : '<i class="bi bi-lightning"></i> Comparar Modelos';
      }
    </script>
  </body>
</html>
